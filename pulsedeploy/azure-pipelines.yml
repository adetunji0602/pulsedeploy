trigger:
  branches:
    include:
      - main

variables:
  IMAGE_NAME: pulsedeploy
  IMAGE_TAG: latest
  ACR_NAME: pulsedeployacr.azurecr.io
  AKS_NAMESPACE: pulsedeploy

stages:

# ================= INFRA STAGE =================
- stage: Terraform
  displayName: "Provision Infrastructure with Terraform"
  jobs:
  - job: terraform
    displayName: "Terraform Apply"
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '1.6.0'

    - task: TerraformTaskV4@4
      displayName: "Terraform Init"
      inputs:
        provider: azurerm
        command: init
        workingDirectory: terraform/aks
        backendServiceArm: Azure-Service-Connection
        backendAzureRmResourceGroupName: tfstate-rg
        backendAzureRmStorageAccountName: tfstateacct
        backendAzureRmContainerName: tfstate
        backendAzureRmKey: aks.tfstate

    - task: TerraformTaskV4@4
      displayName: "Terraform Plan"
      inputs:
        provider: azurerm
        command: plan
        workingDirectory: terraform/aks
        environmentServiceNameAzureRM: Azure-Service-Connection

    - task: TerraformTaskV4@4
      displayName: "Terraform Apply"
      inputs:
        provider: azurerm
        command: apply
        workingDirectory: terraform/aks
        environmentServiceNameAzureRM: Azure-Service-Connection
        commandOptions: "-auto-approve"

# ================= APP BUILD STAGE =================
- stage: Build
  displayName: "Build & Test Application"
  dependsOn: Terraform
  jobs:
  - job: build
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        python -m pip install --upgrade pip
        pip install -r app/requirements.txt
        pip install -e .
      displayName: "Install dependencies"

    - script: pytest
      displayName: "Run Tests"

# ================= DOCKER STAGE =================
- stage: Docker
  displayName: "Build & Push Docker Image"
  dependsOn: Build
  jobs:
  - job: docker
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: Docker@2
      displayName: "Build and Push Image"
      inputs:
        containerRegistry: ACR-Service-Connection
        repository: $(IMAGE_NAME)
        command: buildAndPush
        Dockerfile: docker/Dockerfile
        tags: |
          $(IMAGE_TAG)

# ================= DEPLOY STAGE =================
- stage: Deploy
  displayName: "Deploy to AKS with Helm"
  dependsOn: Docker
  jobs:
  - job: deploy
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Get AKS Credentials"
      inputs:
        azureSubscription: Azure-Service-Connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az aks get-credentials \
            --resource-group rg1-pulsedeploy \
            --name aks-pulsedeploy \
            --overwrite-existing

    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'

    - script: |
        helm upgrade --install pulsedeploy helm/pulsedeploy \
          --namespace pulsedeploy \
          --create-namespace \
          --set image.repository=$(ACR_NAME)/$(IMAGE_NAME) \
          --set image.tag=$(IMAGE_TAG) \
          --set ingress.hosts[0].host=pulsedeploy.westus2.cloudapp.azure.com
      displayName: "Helm Deploy"
